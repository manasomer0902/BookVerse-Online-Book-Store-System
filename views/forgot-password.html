<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Forgot Password | BookVerse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="icon" href="/images/favicon.ico">
</head>
<body>

<header class="navbar">
  <a href="/" class="logo">
    <img src="/images/logo.png">
    <span>BookVerse</span>
  </a>
</header>

<section class="auth-section">
  <div class="auth-card">

    <h2 id="title">Forgot Password</h2>
    <p class="auth-subtitle" id="subtitle">
      Enter your registered email to receive OTP
    </p>

    <!-- STEP 1 -->
    <form id="emailStep" onsubmit="sendOTP(event)">
      <div class="form-group">
        <label>Email Address</label>
        <input type="email" id="email" required>
      </div>
      <button class="btn-primary auth-btn">Send OTP</button>
    </form>

    <!-- STEP 2 -->
    <form id="otpStep" onsubmit="verifyOtp(event)" style="display:none">
      <div class="form-group">
        <label>Enter OTP</label>
        <input type="text" id="otp" required>
      </div>

      <button class="btn-primary auth-btn">Verify OTP</button>

      <button type="button" class="btn-link" onclick="resendOtp()">
        Resend OTP
      </button>
    </form>

    <!-- STEP 3 -->
    <form id="passwordStep" onsubmit="resetPassword(event)" style="display:none">
      <div class="form-group password-group">
        <label>New Password</label>
        <input type="password" id="newPassword" required>
      </div>

      <div class="form-group password-group">
        <label>Confirm Password</label>
        <input type="password" id="confirmPassword" required>
      </div>

      <button class="btn-primary auth-btn">Reset Password</button>
    </form>

    <small id="message" class="error-text"></small>

    <div class="auth-links">
      <a href="/login">Back to Login</a>
    </div>

  </div>
</section>

<script>
/* ================= SEND OTP ================= */
async function sendOTP(e) {
  e.preventDefault();

  const email = document.getElementById("email").value.trim();
  const msg = document.getElementById("message");

  msg.textContent = "";

  const res = await fetch("/api/password/send-otp", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email })
  });

  const data = await res.json();

  if (!res.ok) {
    msg.textContent = data.message;
    return;
  }

  localStorage.setItem("resetUser", email);

  document.getElementById("emailStep").style.display = "none";
  document.getElementById("otpStep").style.display = "block";
  document.getElementById("subtitle").innerText =
    "Enter the OTP sent to your email";
}

/* ================= VERIFY OTP ================= */
async function verifyOtp(e) {
  e.preventDefault();

  const otp = document.getElementById("otp").value.trim();
  const email = localStorage.getItem("resetUser");

  if (!otp || !email) {
    alert("Invalid request");
    return;
  }

  const res = await fetch("/api/password/verify-otp", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, otp })
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.message);
    return;
  }

  document.getElementById("otpStep").style.display = "none";
  document.getElementById("passwordStep").style.display = "block";
  document.getElementById("subtitle").innerText =
    "Set your new password";
}

/* ================= RESEND OTP ================= */
async function resendOtp() {
  const email = localStorage.getItem("resetUser");

  const res = await fetch("/api/password/resend-otp", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email })
  });

  const data = await res.json();
  alert(data.message);
}

/* ================= RESET PASSWORD ================= */
async function resetPassword(e) {
  e.preventDefault();

  const password = document.getElementById("newPassword").value;
  const confirm = document.getElementById("confirmPassword").value;
  const email = localStorage.getItem("resetUser");
  const msg = document.getElementById("message");

  if (password !== confirm) {
    msg.textContent = "Passwords do not match";
    return;
  }

  const res = await fetch("/api/password/reset", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password })
  });

  const data = await res.json();

  if (!res.ok) {
    msg.textContent = data.message;
    return;
  }

  alert("Password reset successful!");
  localStorage.removeItem("resetUser");
  window.location.href = "/login";
}
</script>

</body>
</html>
